#!/bin/bash
#
# Files und Bilder von public/assets/ synchronisieren

# DEFAULTS
# =========================================================================

help=""
remove=""
override=""
path="uploads/"

# get options/arguments
while getopts :p:d:r:o:h option
do
    case "${option}"
    in
        h) help="help";;
        r) remove="remove";;
        o) override="true";;
        d) direction=${OPTARG};;
        p) path=${OPTARG};;
    esac
done

# display help
# -------------------------------------------------------------------------

if [ "${help}" == "help" ]; then

cat << EOF

-------------------------------------------------------------------------
HELP sync-uploads
-------------------------------------------------------------------------

Synchronisiert Dateien in public/assets/*

Optionen:
    -d down     Stage-Server nach Lokal (Standard)
    -d up       Lokal nach Stage-Server

    -p path     Relativer Pfad von Web-Root
                    für ./public/assets: -p assets

    -r          lösche überflüssige Files auf Ziel

-------------------------------------------------------------------------

EOF
exit
fi

# .siteconfig.yaml einlesen
# -------------------------------------------------------------------------

# Prüfe .siteconfig.yaml
if [ ! -e .siteconfig.yaml ]
then
    echo
    echo "In diesem Verzeichnis ist kein .siteconfig.yaml File zu finden. "; echo "Abbruch"; echo ""
    exit
fi

# read .siteconfig.yaml
. yaml-read

# Check siteconfig vars
if [ -z $stage_username ] || [ -z $stage_domain ] || [ -z $stage_path ] || [ -z $public_path ]
then
    cat << EOF

Es sind nicht alle nötigen Variabeln in .siteconfig.yaml definiert:

    stage_username: $stage_username
    stage_domain:   $stage_domain
    stage_path:     $stage_path
    public_path:      $public_path

EOF
    exit;
else

    rsync_local_path="$(pwd)/${public_path}/${path}"
    rsync_stage_path="${stage_path}${path}"

    # Confirm Command
    # -------------------------------------------------------------------------

    if [ "${direction}" == "down" ] || [ -z ${direction} ]; then
        updown="Download"
        echo
        echo "DOWNLOAD assets"
        echo "---------------------------------------------------"
        echo "SSH:          ${stage_username}@${stage_domain}"
        echo "Pfad Lokal:   $rsync_local_path"
        echo "Pfad Live:    ${rsync_stage_path}"
        if [ "${remove}" == "remove" ]; then
            echo "Überflüssige Files Lokal werden gelöscht"
        fi
        echo
    else
        if [ "${direction}" == "up" ]; then
            updown="Upload"
            echo
            echo "UPLOAD assets"
            echo "---------------------------------------------------"
            echo "SSH:          ${stage_username}@${stage_domain}"
            echo "Pfad Lokal:   $rsync_local_path"
            echo "Pfad Live:    ${rsync_stage_path}"
            if [ "${remove}" == "remove" ]; then
                echo "Überflüssige Files auf Server werden gelöscht"
            fi
            echo
        fi
    fi

    if [ "${override}" == "" ]; then

        echo "${updown} ausführen?"
        read -p "[j|N]: " do_rsync

        if [ "${do_rsync}" != 'j' ] && [ "${do_rsync}" != 'y' ]; then
            echo; echo "Abbruch"; echo
            exit
        fi

    fi

    # Sync with rsynch
    # -------------------------------------------------------------------------

    # rsync [-options] source target
    #
    # --delete          delete extraneous files from dest dirs
    # -a                archive mode; equals -rlptgoD (no -H,-A,-X)
    # -v                increase verbosity
    # -z                compress file data during the transfer
    # -e ssh            specify the remote shell to use -> SSH

    if [ "${direction}" == "down" ] || [ -z ${direction} ]; then

        # Down
        # ----

        if [ "${remove}" == "remove" ]; then
            rsync --delete -avze ssh ${stage_username}@${stage_domain}:${rsync_stage_path}/ $rsync_local_path
        else
            rsync -avze ssh ${stage_username}@${stage_domain}:${rsync_stage_path}/ $rsync_local_path
        fi

    else
        if [ "${direction}" == "up" ]; then

            # Up
            # --

            if [ "${remove}" == "remove" ]; then
                rsync --delete -avze ssh ${rsync_local_path}/ ${stage_username}@${stage_domain}:${rsync_stage_path}
            else
                rsync -avze ssh ${rsync_local_path}/ ${stage_username}@${stage_domain}:${rsync_stage_path}
            fi

        else
            echo "Die Richtung (-d ${direction}) kenne ich nicht"; echo
        fi

    fi

fi
